@page "/draganddrop"
@inject IContentService ContentService;
@using BlazorBootstrap;

@rendermode InteractiveServer

<h3>DragAndDropContents</h3>

<SortableList TItem="Content" Data="Contents" Context="contentItem" OnUpdate="OnContentListUpdate">
    <ItemTemplate>
        <div class="row">
            <div class="col d-flex justify-content-end">
                <button class="btn btn-warning">Redigera</button>
                <button class="btn btn-danger">Ta Bort</button>
            </div>
        </div>
        <div class="row">
            <ContentPreview ContentId="@contentItem.ContentId" @key="contentItem.ContentId" />
        </div>
    </ItemTemplate>
</SortableList>


@code {
    [SupplyParameterFromQuery]
    public int? WebPageId { get; set; }

    private List<Content> Contents = new List<Content>();

    protected override async Task OnInitializedAsync()
    {
        if (WebPageId.HasValue)
        {
            // Fetch contents based on the WebPageId
            Contents = await ContentService.GetContentsByWebPageIdAsync(WebPageId.Value);
        }
    }

    private async Task OnContentListUpdate(SortableListEventArgs args)
    {
        // Validate indexes
        if (args.OldIndex < 0 || args.OldIndex >= Contents.Count || args.NewIndex < 0 || args.NewIndex >= Contents.Count)
            return;

        // Move the item in the Contents list
        var itemToMove = Contents[args.OldIndex];
        Contents.RemoveAt(args.OldIndex);

        if (args.NewIndex < Contents.Count)
        {
            Contents.Insert(args.NewIndex, itemToMove);
        }
        else
        {
            Contents.Add(itemToMove);
        }

        // Update order and save to the database
        await UpdateContentOrder();

        // Force re-render to reflect updated order visually
        //StateHasChanged();
    }

    private async Task UpdateContentOrder()
    {
        // Set order values based on new list arrangement
        for (int i = 0; i < Contents.Count; i++)
        {
            Contents[i].Order = i; // Assign order index
        }

        // Save the updated order in the database
        await ContentService.UpdateContentOrderAsync(Contents);
    }
}
